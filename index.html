<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#195bdc" />
  <title>App thi trắc nghiệm từ Excel (v22.1)</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico" />
  <link rel="manifest" href="manifest.webmanifest" crossorigin="use-credentials" />
  <style>
    :root{ --ok:#19c37d; --bad:#ef4444; --bg:#fff; --fg:#111; --card:#fff; --border:#d1d5db; --muted:#6b7280; }
    body.dark{ --bg:#0f172a; --fg:#f1f5f9; --card:#1e293b; --border:#334155; --muted:#94a3b8; }
    body{font-family:Inter,"Be Vietnam Pro",Arial,sans-serif;margin:0;padding:0;background:var(--bg);color:var(--fg);transition:background .3s,color .3s}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .card{border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px;background:var(--card)}
    .btn{padding:8px 12px;margin:4px 0;border:1px solid var(--border);border-radius:8px;cursor:pointer;background:#f3f4f6}
    body.dark .btn{background:#334155;color:#f1f5f9}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .toolbar{display:flex;gap:16px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap}
    .toolbar .left{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .toolbar .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .timer{font-weight:800;font-variant-numeric:tabular-nums;border:1px dashed var(--border);border-radius:10px;padding:8px 10px}
    .q{font-weight:700;margin:14px 0}
    .opt{display:flex;gap:10px;align-items:center;border:1px solid var(--border);border-radius:10px;padding:10px 12px;margin:8px 0}
    .opt.correct{background:#e9fff5;border-color:var(--ok);font-weight:700}
    .opt.wrong{background:#ffefef;border-color:var(--bad)}
    .muted{color:var(--muted)}
    input[type="number"]{width:80px}
    .stats{margin-left:12px;font-weight:600;color:var(--muted)}
    .globalstats{margin-left:12px;font-weight:600;color:var(--muted)}
  </style>
</head>
<body class="light">
  <div class="wrap">
    <!-- TOP BAR -->
    <div class="card toolbar">
      <div class="left">
        <input id="file" type="file" accept=".xlsx,.xls" />
        <button id="btnLoad" class="btn">Nạp đề</button>
        <label>Số câu: <input id="numQ" type="number" value="30" min="1"></label>
        <label><input id="chkShuffle" type="checkbox" checked> Ngẫu nhiên</label>
        <button id="btnMake" class="btn">Tạo đề</button>
        <span id="bankStat" class="muted">Chưa nạp đề</span>
        <span id="stats" class="stats"></span>
        <button id="btnTheme" class="btn">Chế độ: Sáng</button>
      </div>
      <div class="right">
        <div class="timer">⏳ <span id="timer">--:--</span></div>
        <button id="btnSubmit" class="btn" disabled>Nộp bài</button>
        <button id="btnExport" class="btn" disabled>Lưu bài thi</button>
        <span id="globalStats" class="globalstats"></span>
      </div>
    </div>

    <!-- FULL-WIDTH QUESTIONS -->
    <div id="quiz" class="card">Danh sách câu hỏi sẽ hiển thị tại đây…</div>
  </div>

  <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
  let bank=[], quiz=[];
  let secondsLeft=0, tHandle=null;
  let nextStart=0;
  let remainingShuffle=[];
  let lastBatch=[];

  const el=id=>document.getElementById(id);
  const initialQuizMsg=el('quiz').innerHTML;
  const LETTERS=['A','B','C','D','E','F'];
  const rxKey=/^\s*([A-F])\s*[\.|\)|:|-]?/i;

  function splitLetters(s){
    return String(s||'').toUpperCase().split(/[^A-F]+/).map(x=>x.trim()).filter(x=>/^[A-F]$/.test(x));
  }
  function asKeySet(s){
    return new Set(splitLetters(s));
  }
  function escapeHtml(s){
    return String(s).replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
  }
  function shuffleArr(a){
    for(let i=a.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }
  function resetPools(){
    nextStart=0;
    remainingShuffle=[...Array(bank.length).keys()];
    lastBatch=[];
  }
  function ensureShufflePool(n){
    if(bank.length===0 || remainingShuffle.length>=n) return;
    const pool=new Set(remainingShuffle);
    const canSkipLast=n<bank.length && lastBatch.length>0;
    const excluded=canSkipLast?new Set(lastBatch):null;
    for(let i=0;i<bank.length;i++){
      if(excluded && excluded.has(i)) continue;
      pool.add(i);
    }
    remainingShuffle=Array.from(pool);
    if(remainingShuffle.length<n){
      remainingShuffle=[...Array(bank.length).keys()];
    }
  }
  function buildQuizFromIndices(indices){
    quiz=indices.map(i=>{
      const base=bank[i];
      return {
        question: base.question,
        opts: base.opts,
        correct: base.correct,
        selected: new Set()
      };
    });
  }
  function calcRight(){
    let right=0;
    quiz.forEach(q=>{
      const picked=Array.from(q.selected);
      if(q.correct.size<=1){
        if(picked.length===1 && q.correct.has(picked[0])) right++;
      } else if(picked.length===q.correct.size && picked.every(k=>q.correct.has(k))){
        right++;
      }
    });
    return right;
  }
  function refreshStats(){
    const total=quiz.length||0;
    const right=calcRight();
    if(total){
      const percent=((right/total)*100).toFixed(1);
      el('stats').textContent=`Dung ${right}/${total}`;
      el('globalStats').textContent=`Tong dung: ${right}/${total} (${percent}%)`;
    } else {
      el('stats').textContent='';
      el('globalStats').textContent='';
    }
    return right;
  }
  function clearQuiz(){
    quiz=[];
    el('quiz').innerHTML=initialQuizMsg;
    el('btnSubmit').disabled=true;
    el('btnExport').disabled=true;
    refreshStats();
    stopTimer();
    el('timer').textContent='--:--';
  }
  function validateBank(){
    const issues=[];
    bank.forEach((q,idx)=>{
      const prefix=`Cau ${idx+1}`;
      if(!q.question || !String(q.question).trim()){
        issues.push(`${prefix}: thieu noi dung cau hoi.`);
      }
      if(!Array.isArray(q.opts) || q.opts.length===0){
        issues.push(`${prefix}: khong co lua chon tra loi.`);
      }
      const seen=new Set();
      q.opts.forEach((opt,optIdx)=>{
        const key=(opt.key||'').toString().toUpperCase();
        if(seen.has(key)){
          issues.push(`${prefix}: trung lua chon ${key}.`);
        } else {
          seen.add(key);
        }
        if(!opt.text || !String(opt.text).trim()){
          issues.push(`${prefix}: lua chon thu ${optIdx+1} bi trong.`);
        }
      });
      if(q.correct.size===0){
        issues.push(`${prefix}: chua danh dau dap an dung.`);
      } else {
        q.correct.forEach(key=>{
          if(!seen.has(key)){
            issues.push(`${prefix}: dap an ${key} khong ton tai trong lua chon.`);
          }
        });
      }
    });
    return issues;
  }
  function fmt(secs){
    const m=String(Math.floor(secs/60)).padStart(2,'0');
    const s=String(secs%60).padStart(2,'0');
    return `${m}:${s}`;
  }
  function stopTimer(){
    if(tHandle){
      clearInterval(tHandle);
      tHandle=null;
    }
  }
  function startTimer(mins){
    stopTimer();
    secondsLeft=Math.max(1,mins)*60;
    el('timer').textContent=fmt(secondsLeft);
    tHandle=setInterval(()=>{
      secondsLeft--;
      el('timer').textContent=fmt(Math.max(0,secondsLeft));
      if(secondsLeft<=0){
        stopTimer();
        autoSubmit();
      }
    },1000);
  }

  el('btnLoad').onclick=async()=>{
    const f=el('file').files?.[0];
    if(!f){
      alert('Chon file');
      return;
    }
    try{
      const ab=await f.arrayBuffer();
      const wb=XLSX.read(ab,{type:'array'});
      const ws=wb.Sheets[wb.SheetNames[0]];
      const rows=XLSX.utils.sheet_to_json(ws,{defval:"",raw:true});
      bank=[];
      let cur=null;
      rows.forEach(r=>{
        const A=(r['NoiDung']??'').toString();
        const B=(r['DapAnDung']??'').toString();
        const D=(r['CauHoi']??'').toString().trim().toUpperCase();
        if(D==='CH'){
          cur={question:A,opts:[],correct:asKeySet(B),_used:new Set()};
          bank.push(cur);
        } else if(cur && A.trim()!==''){
          let key='';
          const m=A.match(rxKey);
          if(m){
            key=m[1].toUpperCase();
          } else {
            key=LETTERS.find(ch=>!cur._used.has(ch))||'X';
          }
          if(cur._used.has(key)){
            key=LETTERS.find(ch=>!cur._used.has(ch))||key;
          }
          cur._used.add(key);
          cur.opts.push({key,text:A});
          const mark=B.toString().trim();
          if(mark!==''){
            const letters=splitLetters(mark);
            if(letters.length===0 || letters.includes(key)){
              cur.correct.add(key);
            }
          }
        }
      });
      bank.forEach(q=>delete q._used);
      resetPools();
      clearQuiz();
      const issues=validateBank();
      let status=`Da nap ${bank.length} cau hoi.`;
      if(issues.length){
        console.warn('Canh bao ngan hang cau hoi:', issues);
        const preview=issues.slice(0,5).map(msg=>`- ${msg}`).join('\n');
        alert(`Phat hien ${issues.length} canh bao trong file cau hoi:\n${preview}${issues.length>5?'\n- ...':''}`);
        status+=` - ${issues.length} canh bao.`;
      }
      el('bankStat').textContent=status;
    } catch(err){
      console.error('Khong the doc file Excel', err);
      alert('Khong the doc file. Vui long thu lai.');
    }
  };

  el('btnMake').onclick=()=>{
    if(bank.length===0){
      alert('Ban chua nap de?');
      return;
    }
    const want=parseInt(el('numQ').value||'30',10);
    const n=Math.max(1,Math.min(Number.isFinite(want)?want:30,bank.length));
    const doShuffle=el('chkShuffle').checked;

    if(doShuffle){
      ensureShufflePool(n);
      shuffleArr(remainingShuffle);
      const pick=remainingShuffle.splice(0,n);
      lastBatch=pick.slice();
      buildQuizFromIndices(pick);
    } else {
      const start=nextStart;
      const end=Math.min(start+n,bank.length);
      const idx=[];
      for(let i=start;i<end;i++) idx.push(i);
      if(end-start<n && bank.length>0){
        for(let i=0;i<n-(end-start);i++) idx.push(i);
      }
      lastBatch=idx.slice();
      nextStart=(start+n)%bank.length;
      buildQuizFromIndices(idx);
    }

    renderQuiz();
    el('btnSubmit').disabled=false;
    el('btnExport').disabled=false;
    startTimer(quiz.length);
    refreshStats();
  };

  function renderQuiz(){
    const box=el('quiz');
    box.innerHTML='';
    quiz.forEach((q,i)=>{
      const card=document.createElement('div');
      card.className='qcard';
      card.innerHTML=`<div class='q'>Cau ${i+1}. ${escapeHtml(q.question)}</div>`;
      const multi=q.correct.size>1;
      q.opts.forEach(o=>{
        const key=(o.key||'').toString().toUpperCase();
        const line=document.createElement('label');
        line.className='opt';
        const inp=document.createElement('input');
        inp.type=multi?'checkbox':'radio';
        inp.name='q'+i;
        inp.value=key;
        inp.checked=q.selected.has(key);
        inp.addEventListener('change',()=>{
          if(multi){
            if(inp.checked){
              q.selected.add(key);
            } else {
              q.selected.delete(key);
            }
          } else {
            q.selected.clear();
            if(inp.checked){
              q.selected.add(key);
            }
          }
          refreshStats();
        });
        line.appendChild(inp);
        line.appendChild(document.createTextNode(' '+o.text));
        card.appendChild(line);
      });
      const peek=document.createElement('button');
      peek.className='btn';
      peek.textContent='Kiem tra cau nay';
      peek.onclick=()=>{
        peekQuestion(card,q);
        refreshStats();
      };
      card.appendChild(peek);
      box.appendChild(card);
    });
  }

  function peekQuestion(card,q){
    card.querySelectorAll('label.opt').forEach(l=>{
      l.classList.remove('correct','wrong');
      const key=l.querySelector('input').value.toUpperCase();
      if(q.correct.has(key)){
        l.classList.add('correct');
      }
    });
  }

  function gradeAndPaint(){
    const cards=document.querySelectorAll('.qcard');
    let right=0;
    quiz.forEach((q,i)=>{
      const card=cards[i];
      const picked=new Set(q.selected);
      card.querySelectorAll('label.opt').forEach(l=>{
        l.classList.remove('correct','wrong');
        const input=l.querySelector('input');
        const key=input.value.toUpperCase();
        if(input.checked){
          picked.add(key);
        } else {
          picked.delete(key);
        }
        if(q.correct.has(key)){
          l.classList.add('correct');
        } else if(input.checked){
          l.classList.add('wrong');
        }
      });
      q.selected=picked;
      const chosen=Array.from(picked);
      if(q.correct.size<=1){
        if(chosen.length===1 && q.correct.has(chosen[0])) right++;
      } else if(chosen.length===q.correct.size && chosen.every(k=>q.correct.has(k))){
        right++;
      }
    });
    const total=quiz.length||0;
    if(total){
      const percent=((right/total)*100).toFixed(1);
      el('stats').textContent=`Dung ${right}/${total}`;
      el('globalStats').textContent=`Tong dung: ${right}/${total} (${percent}%)`;
    } else {
      el('stats').textContent='';
      el('globalStats').textContent='';
    }
    return right;
  }

  function autoSubmit(){
    const right=gradeAndPaint();
    el('btnSubmit').disabled=true;
    alert(`Het gio. Ban dung ${right}/${quiz.length} cau.`);
  }

  el('btnSubmit').onclick=()=>{
    stopTimer();
    const right=gradeAndPaint();
    el('btnSubmit').disabled=true;
    alert(`Ban lam dung ${right}/${quiz.length} cau.`);
  };

  el('btnExport').onclick=()=>{
    const src=quiz.length?quiz:bank;
    let html=`<!DOCTYPE html><html lang='vi'><head><meta charset='utf-8'><title>Bai thi duoc luu</title><style>body{font-family:Inter,Arial,sans-serif;padding:20px;line-height:1.6;color:#111}.q{font-weight:700;margin-top:16px}.opt{margin:6px 0;padding:8px;border:1px solid #ccc;border-radius:8px}.correct{background:#e9fff5;border-color:#19c37d;font-weight:700}</style></head><body>`;
    src.forEach((q,i)=>{
      html+=`<div class='q'>Cau ${i+1}. ${escapeHtml(q.question)}</div>`;
      q.opts.forEach(o=>{
        const optKey=(o.key||'').toString().toUpperCase();
        const isTrue=q.correct.has(optKey);
        html+=`<div class='opt ${isTrue?'correct':''}'>${escapeHtml(o.text)}</div>`;
      });
    });
    html+='</body></html>';
    const blob=new Blob([html],{type:'text/html;charset=utf-8'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    const now=new Date();
    const fname=`DeThi_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}.html`;
    a.download=fname;
    a.click();
    URL.revokeObjectURL(a.href);
  };

  el('btnTheme').onclick=()=>{
    const isDark=document.body.classList.toggle('dark');
    el('btnTheme').textContent=isDark?'Che do: Toi':'Che do: Sang';
  };

  if('serviceWorker' in navigator){
    window.addEventListener('load',()=>{
      navigator.serviceWorker.register('sw.js').catch(err=>console.error('SW registration failed',err));
    });
  }
</script>
</body>
</html>
